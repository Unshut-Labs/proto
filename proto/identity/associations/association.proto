syntax = "proto3";

package xmtp.identity.associations;

import "identity/associations/signature.proto";

option go_package = "github.com/xmtp/proto/v3/go/identity/associations";
option java_package = "org.xmtp.proto.identity.associations";

// The first entry of any XID log. The XID must be deterministically derivable
// from the address and nonce.
// The recovery address defaults to the initial associated_address unless
// there is a subsequent ChangeRecoveryAddress in the log.
message CreateXid {
  string xid = 1;
  uint32 nonce = 2;
  Signature initial_member_signature = 3;
}

message AddAssociation {
  enum AssociatedRole {
    ASSOCIATED_ROLE_UNSPECIFIED = 0;
    ASSOCIATED_ROLE_INSTALLATION = 1;
    ASSOCIATED_ROLE_ADDRESS = 2;
    ASSOCIATED_ROLE_LEGACY_KEY = 3; // TODO: clarify how this is used
  }

  string xid = 1;
  uint64 client_timestamp_ns = 2;
  AssociatedRole new_member_role = 3;
  Signature existing_member_signature = 4;
  Signature new_member_signature = 5;
}

// An entity may have been associated with multiple roles. Clients MUST remove
// the entity from all previously associated roles.
message RevokeAssociation {
  string xid = 1;
  uint64 client_timestamp_ns = 2;
  // Either an installation public key or a wallet address
  string revoked_member = 3;
  Signature recovery_address_signature = 4;
}

message ChangeRecoveryAddress {
  string xid = 1;
  uint64 client_timestamp_ns = 2;
  string new_recovery_address = 3;  // TODO clarify if recovery address must be member and permissions
  Signature existing_recovery_address_signature = 4;
}

message IdentityUpdate {
  uint64 server_timestamp_ns = 1;
  oneof kind {
    CreateXid create = 2;
    AddAssociation add = 3;
    RevokeAssociation revoke = 4;
    ChangeRecoveryAddress change_recovery_address = 5;
  }
}
